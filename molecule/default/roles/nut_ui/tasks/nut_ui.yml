---
- name: Verify NUT UI files attributes
  block:
    - name: Get the list of NUT UI files
      ansible.builtin.find:
        paths: "{{ nut_ui_dir }}"
        recurse: true
        file_type: file
      register: nut_ui_files

    - name: Stat NUT UI files
      ansible.builtin.stat:
        path: "{{ file }}"
      register: nut_ui_files_stat
      loop: "{{ nut_ui_files.files | map(attribute='path') }}"
      loop_control:
        loop_var: file

    - name: Assert NUT UI files mode
      ansible.builtin.assert:
        that: file.mode | string == services_file_mode
        fail_msg: "File '{{ file.path }}' has incorrect mode: {{ file.mode }}"
        success_msg: "File '{{ file.path }}' has correct mode"
      loop: >-
        {{ nut_ui_files_stat.results
          | map(attribute='stat')
          | map('dict2items')
          | map('selectattr', 'key', 'in', ['path', 'mode'])
          | map('items2dict') }}
      loop_control:
        loop_var: file

    - name: Assert NUT UI files ownership
      ansible.builtin.assert:
        that:
          - file.pw_name == services_owner
          - file.gr_name == services_group
        fail_msg: >-
          File '{{ file.path }}' has incorrect ownership:
          {{ file.pw_name }}:{{ file.gr_name }}
        success_msg: "File '{{ file.path }}' has correct ownership"
      loop: >-
        {{ nut_ui_files_stat.results
          | map(attribute='stat')
          | map('dict2items')
          | map('selectattr', 'key', 'in', ['path', 'pw_name', 'gr_name'])
          | map('items2dict') }}
      loop_control:
        loop_var: file

- name: Verify NUT UI files content
  block:
    - name: Slurp NUT UI files content
      ansible.builtin.slurp:
        src: "{{ file }}"
      register: nut_ui_files_slurp
      loop: "{{ nut_ui_files.files | map(attribute='path') }}"
      loop_control:
        loop_var: file

    - name: Assert NUT UI files have Unix line endings
      ansible.builtin.assert:
        that: "'\\r\\n' not in (file.content | b64decode)"
        fail_msg: "File '{{ file.file }}' contains Windows line endings (CRLF)"
        success_msg: "File '{{ file.file }}' has Unix line endings (LF)"
      loop: >-
        {{ nut_ui_files_slurp.results
          | map('dict2items')
          | map('selectattr', 'key', 'in', ['file', 'content'])
          | map('items2dict') }}
      loop_control:
        loop_var: file

- name: Verify NUT UI Docker containers
  block:
    - name: Get NUT UI containers info
      community.docker.docker_container_info:
        name: "{{ container_name }}"
      register: nut_ui_containers_info
      loop:
        - "{{ nut_ui_container_name }}"
        - "{{ nut_ui_cgi_container_name }}"
        - "{{ nut_ui_exporter_container_name }}"
      loop_control:
        loop_var: container_name

    - name: Assert NUT UI containers are running
      ansible.builtin.assert:
        that: container_info.State.Status == "running"
        fail_msg: >-
          Container '{{ container_info.Name }}' has incorrect state:
          status='{{ container_info.State.Status }}'
        success_msg: >-
          Container '{{ container_info.Name }}' has correct state:
          status='{{ container_info.State.Status }}'
      loop: >-
        {{ nut_ui_containers_info.results
          | map(attribute='container')
          | map('dict2items')
          | map('selectattr', 'key', 'in', ['Name', 'State'])
          | map('items2dict') }}
      loop_control:
        loop_var: container_info
